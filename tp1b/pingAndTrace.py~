#! /usr/bin/env python

import logging
import httplib2
import json
import sys
from math import *
import datetime
from time import sleep

logging.getLogger("scapy").setLevel(1)

from scapy.all import *
from time import *

key = "6f7ef1159eb53bba3ebd9e24969aa216d0dec8ce85e483021c14da8546985653"
geoipUrl = "http://api.ipinfodb.com/v3/ip-city/?key=" + key +"&format=json"

def ping(ip, cant = 10):
	ipPacket = IP(dst=ip)
	timeSum = 0
	pings = 0
	for x in range(cant):
		icmp = ICMP(seq=x)
		t1=time()
		ans = sr(ipPacket/icmp, timeout=2, verbose=0)
		if(len(ans[0]) == 0):
			continue
		t2=time()
		ipAns = ans[0][0][1]
		icmpAns = ans[0][0][1][1]
		timeStr = str((t2-t1)*1000) + " ms"
		timeSum += (t2-t1)*1000
		pings += 1
		print str(ipAns.len) + " bytes from " + ipAns.src + ": req = " + str(icmpAns.seq) + " ttl = "+str(ipAns.ttl) + " time = "+timeStr

	if(pings>0):
		print "Avrg. time = "+str(timeSum/pings)+"ms"
		return timeSum/pings

def pingEnlaces(ip1, ip2):
	f = open("pingEnlaces", 'a')
	ping1 = ping(ip1)
	ping2 = ping(ip2)
	seq = ["Ping a " +ip1+ " Avrg. time = " +str(ping1)+"ms\n","Ping a " +ip2+ " Avrg. time = " +str(ping2)+"ms\n", "Diferencia = " + str(ping2-ping1)+"ms\n\n"]
	f.writelines(seq)
	f.close()

def traceroute(ip):
	myTtl = 1

	host = IP()
	resp, content = httplib2.Http(timeout=2).request(geoipUrl)
	decoded = json.loads(content)
	print str(myTtl) +" "+host.src + "  "+ decoded["cityName"] + ", "+decoded["regionName"]+", "+decoded["countryName"] + "   Lat="+str(decoded["latitude"])+ " Long="+str(decoded["longitude"])

	distancias = (host.src,decoded["cityName"] + " "+decoded["countryName"],decoded["latitude"],decoded["longitude"]),

	while True and myTtl < 21:
		ipPacket = IP(dst=ip, ttl=myTtl)
		t1=time()
		ans = sr(ipPacket/ICMP(), timeout=5, verbose=0)
		
		if(len(ans[0]) == 0):
			print str(myTtl)+" * no response *"
			myTtl = myTtl + 1
			continue
		t2=time()
		timeStr = str((t2-t1)*1000) + " ms"
		ipAns = ans[0][0][1]
		#print str(myTtl) +" "+ipAns.src
		try:
			resp, content = httplib2.Http(timeout=2).request(geoipUrl+"&ip="+ipAns.src)
			#print content
			decoded = json.loads(content)
			print str(myTtl) +" "+ipAns.src + "  "+ decoded["cityName"] + ", "+decoded["regionName"]+", "+decoded["countryName"] + "   Lat="+str(decoded["latitude"])+ " Long="+str(decoded["longitude"]) + "   Time="+timeStr
			if decoded["countryName"] != "-":
				distancias += (ipAns.src,decoded["cityName"] + " "+decoded["countryName"] ,decoded["latitude"],decoded["longitude"]),
		except:
			print str(myTtl) +" "+ipAns.src+ "   Time="+timeStr

		
		if (ans[0][0][0].dst == ipAns.src):
			break;

		myTtl = myTtl + 1

	
	#print distancias
	distanciaTotal = 0
	print "\n"
	for i in range(len(distancias)-1):
		aux = haversine(distancias[i][2], distancias[i+1][2], distancias[i][3], distancias[i+1][3]) 
		print "Desde " + distancias[i][1] + " Hasta " + distancias[i+1][1] + " " + str(aux)
		distanciaTotal += aux

	print "\nLa distancia total recorrida hasta llegar al enlace final fue de: " + str(distanciaTotal)


def haversine(lat1, lat2, lon1, lon2):
	lat1, lat2, lon1, lon2 = float(lat1), float(lat2), float(lon1), float(lon2)
	lat1, lat2, lon1, lon2 = radians(lat1), radians(lat2), radians(lon1), radians(lon2)
	res = 2*6378.14 * asin(sqrt(sin((lat1-lat2)/2)**2 + cos(lat1) * cos(lat2) * sin((lon1-lon2)/2)**2))
	return res

	#http://en.wikipedia.org/wiki/Haversine_formula


def batchTrace():
	f = open("IPs", 'r')
	sys.stdout = open("resultados", 'w')
	temp = f.read().splitlines()
	for lines in temp:
		print("trace de la ip: " + lines + "\n")
		traceroute(lines)
		print("\n\n\n")
	f.close()
	sys.stdout = sys.__stdout__

	#http://www.projecthoneypot.org
	

def ResultadosEnlaces():
	while 1:
		f = open("pingEnlaces", 'a')
		now = datetime.datetime.now()
		f.write("MEDICION DE: " + now.strftime("%Y-%m-%d %H:%M:%S") + "\n\n")
		f.write("PRIMER ENLACE\n\n")
		f.close()
		pingEnlaces("157.130.90.238", "80.91.252.37")
		pingEnlaces("157.130.249.230","134.222.231.229")
		pingEnlaces("66.198.70.1","80.231.130.33")
		f = open("pingEnlaces", 'a')
		f.write("SEGUNDO ENLACE\n\n")
		f.close()
		pingEnlaces("89.149.185.41","24.222.79.54")
		f = open("pingEnlaces", 'a')
		f.write("TERCER ENLACE\n\n")
		f.close()
		pingEnlaces("157.130.88.62","93.186.128.210")
		pingEnlaces("157.130.88.62","195.22.196.185")
		sleep(1800)
	f.close()



if __name__ == "__main__":
    interact(mydict=globals(), mybanner="PING AND TRACEROUTE")
